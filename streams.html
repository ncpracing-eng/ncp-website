<script>
  const SHEET_ID = "1ZweNs9pfLIpNidgOMhtSfazjgHvt1o084sFR-zmX8Pw";
  const SHEET_NAME = "Streamer";
  const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

  async function loadStreams() {
    try {
      const res = await fetch(SHEET_URL);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));
      const rows = json.table.rows.slice(1); // erste Zeile ignorieren

      const liveContainer = document.getElementById("live-streams");
      const offlineContainer = document.getElementById("offline-streams");
      liveContainer.innerHTML = "";
      offlineContainer.innerHTML = "";

      for (const row of rows) {
        const name = row.c[0]?.v || "";
        const twitchUser = row.c[1]?.v?.trim() || "";
        if (!twitchUser) continue;

        // Twitch Preview-Bild laden
        const previewUrl = `https://static-cdn.jtvnw.net/previews-ttv/live_user_${twitchUser}-320x180.jpg?rand=${Date.now()}`;

        // Bild laden und prüfen, ob es sich ändert (live) oder Standardbild (offline)
        const isLive = await checkIfLive(previewUrl);

        addStream(name, twitchUser, isLive);
      }

      console.log("✅ Streams aktualisiert:", new Date().toLocaleTimeString());
    } catch (err) {
      console.error("Fehler beim Laden der Stream-Daten:", err);
    }
  }

  // Prüfen, ob Stream live ist → anhand der Größe des Preview-Bildes
  async function checkIfLive(url) {
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) return false;

      const blob = await res.blob();
      // Standard Offline-Vorschaubild ist meist sehr klein (< 10KB)
      return blob.size > 20000; // ca. 20 KB = live
    } catch {
      return false;
    }
  }

  // Stream-Karten erzeugen
  function addStream(name, twitchUser, isLive) {
    const container = document.getElementById(isLive ? "live-streams" : "offline-streams");
    const card = document.createElement("div");
    card.classList.add("stream-card");

    if (isLive) {
      card.innerHTML = `
        <div class="stream-video">
          <iframe
            src="https://player.twitch.tv/?channel=${twitchUser}&parent=${location.hostname}"
            allow="autoplay; fullscreen"
            frameborder="0">
          </iframe>
        </div>
        <div class="stream-info">
          <h3>${name}</h3>
        </div>`;
    } else {
      const previewUrl = `https://static-cdn.jtvnw.net/previews-ttv/live_user_${twitchUser}-320x180.jpg`;
      card.innerHTML = `
        <a href="https://twitch.tv/${twitchUser}" target="_blank" class="offline-box">
          <img src="${previewUrl}" alt="${name}">
          <div class="offline-overlay">Offline</div>
          <h4>${name}</h4>
        </a>`;
    }

    container.appendChild(card);
  }

  // Initial laden + alle 5 Minuten neu prüfen
  loadStreams();
  setInterval(loadStreams, 5 * 60 * 1000);
</script>
